{% extends 'base.html' %}
{% load static %}

{% block title %}Profile - Bridge Online School{% endblock %}

{% block head_extra %}
<!-- jQuery CDN - Required for profile functionality -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
{% endblock %}

{% block description %}Manage your Bridge Online School profile, view recent activity, and update your account settings. Track your lesson purchases and reviews.{% endblock %}

{% block keywords %}bridge profile, student dashboard, lesson history, bridge account settings{% endblock %}

{% block content %}
  <!-- Profile Section -->
  <section class="auth-container">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="auth-box">
            <div class="row g-0">
              <!-- Sidebar with navigation -->
              <div class="col-auto">
                <div class="profile-sidebar h-100">
                  <div class="profile-header mb-4">
                    <div class="profile-avatar">
                      <i class="bi bi-file-person"></i>
                    </div>
                  </div>
                  
                  <nav class="profile-nav">
                    <ul class="list-unstyled">
                      <li class="mb-3">
                        <a href="#settings" class="profile-nav-link active" data-section="settings">
                          <i class="bi bi-gear"></i>
                        </a>
                      </li>
                      <li class="mb-3">
                        <a href="#teacher" class="profile-nav-link" data-section="teacher">
                          <i class="bi bi-person-video3"></i>
                        </a>
                      </li>
                      <li class="mb-3">
                        <a href="#notifications" class="profile-nav-link" data-section="notifications">
                          <i class="bi bi-bell"></i>
                        </a>
                      </li>
                    </ul>
                  </nav>
                </div>
              </div>
              
              <!-- Main content area -->
              <div class="col">
                <div class="profile-content">
                  <!-- Settings Section -->
                  <div id="settings-section" class="profile-section active">
                    <h3 class="mb-4">Account Settings</h3>
                    
                    {% if messages %}
                      {% for message in messages %}
                        <ul class="errorlist">
                          <li>{{ message }}</li>
                        </ul>
                      {% endfor %}
                    {% endif %}

                    <form method="POST" action="{% url 'authentication:profile' %}">
                      {% csrf_token %}
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="firstName" name="first_name" value="{{ user.first_name }}" placeholder="First Name" maxlength="100">
                            <label for="firstName">First Name</label>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="lastName" name="last_name" value="{{ user.last_name }}" placeholder="Last Name" maxlength="100">
                            <label for="lastName">Last Name</label>
                          </div>
                        </div>
                      </div>
                      
                      <div class="form-floating mb-3">
                        <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" placeholder="Email" maxlength="254">
                        <label for="email">Email</label>
                      </div>
                      
                      <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="username" name="username" value="{{ user.username }}" placeholder="Username" maxlength="50">
                        <label for="username">Username</label>
                      </div>
                      
                      <hr class="my-4">
                      
                      <h5 class="mb-3">Change Password</h5>

                      <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="newPassword" name="new_password" placeholder="New Password">
                        <label for="newPassword">New Password</label>
                      </div>
                      
                      <div class="form-floating mb-4">
                        <input type="password" class="form-control" id="confirmPassword" name="confirm_password" placeholder="Confirm New Password">
                        <label for="confirmPassword">Confirm New Password</label>
                      </div>
                      
                      <button class="btn-getstarted rounded-pill" type="submit">Save Changes</button>
                    </form>
                  </div>
                  
                  <!-- Teacher Profile Section -->
                  <div id="teacher-section" class="profile-section">
                    <h3 class="mb-4">Teacher Profile</h3>
                    
                    {% if teacher_profile %}
                      {% if teacher_profile.is_active %}
                        <div class="alert alert-success d-flex align-items-center mb-4">
                          <i class="bi bi-check-circle-fill me-2"></i>
                          <div>
                            <strong>Teacher Profile Active!</strong> Your teacher profile is currently active and visible to students.
                          </div>
                        </div>
                      {% else %}
                        <div class="alert alert-warning d-flex align-items-center">
                          <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <div>
                          <strong>Teacher Profile is Under Review!</strong> Wait for our administrators decision.
                        </div>
                      </div>
                      {% endif %}
                    {% else %}
                      <div class="alert alert-info d-flex align-items-center mb-4">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <div>
                          <strong>Become a Teacher!</strong> Create your teacher profile to start offering lessons and courses.
                        </div>
                      </div>
                    {% endif %}

                    {% if messages %}
                      {% for message in messages %}
                        {% if 'Teacher' in message.message or 'teacher' in message.message %}
                          <ul class="errorlist">
                            <li>{{ message }}</li>
                          </ul>
                        {% endif %}
                      {% endfor %}
                    {% endif %}

                    <form method="POST" action="{% url 'authentication:profile' %}" enctype="multipart/form-data">
                      {% csrf_token %}
                      
                      <div class="mb-4">
                        <h5 class="mb-3">Personal Information</h5>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="teacherFirstName" value="{{ user.first_name }}" disabled>
                              <label for="teacherFirstName">First Name (Auto-filled)</label>
                              <small class="form-text text-muted">This is automatically filled from your account information.</small>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-floating mb-3">
                              <input type="text" class="form-control" id="teacherLastName" value="{{ user.last_name }}" disabled>
                              <label for="teacherLastName">Last Name (Auto-filled)</label>
                              <small class="form-text text-muted">This is automatically filled from your account information.</small>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="mb-4">
                        <h5 class="mb-3">Professional Information</h5>
                        
                        <div class="form-floating mb-3">
                          {{ teacher_form.title }}
                          <label for="{{ teacher_form.title.id_for_label }}">Professional Title *</label>
                          <small class="form-text text-muted">e.g., Mathematics Teacher, English Tutor, Piano Instructor</small>
                        </div>
                        
                        <div class="mb-3">
                          <label for="{{ teacher_form.experience.id_for_label }}" class="form-label">Professional Teaching Experience *</label>
                          {{ teacher_form.experience }}
                          <small class="form-text text-muted">Describe your professional teaching experience, qualifications, areas of expertise, and educational background (maximum 500 characters)</small>
                        </div>
                        
                        <div class="form-floating mb-3">
                          {{ teacher_form.teaching_years }}
                          <label for="{{ teacher_form.teaching_years.id_for_label }}">Years of Teaching Experience</label>
                          <small class="form-text text-muted">How many years have you been teaching? (optional)</small>
                        </div>
                      </div>

                      <div class="mb-4">
                        <h5 class="mb-3">Profile & Pricing</h5>
                        
                        <div class="mb-3">
                          <label for="{{ teacher_form.avatar.id_for_label }}" class="form-label">Profile Picture *</label>
                          {{ teacher_form.avatar }}
                          <small class="form-text text-muted">Upload a professional photo that will be displayed on your teacher profile</small>
                          {% if teacher_profile and teacher_profile.avatar %}
                            <div class="mt-2">
                              <small class="text-success">
                                <i class="bi bi-check-circle me-1"></i>Current image: {{ teacher_profile.avatar.name|slice:":50" }}
                              </small>
                            </div>
                          {% endif %}
                        </div>
                        
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-floating mb-3">
                              {{ teacher_form.lesson_price }}
                              <label for="{{ teacher_form.lesson_price.id_for_label }}">Lesson Price (USD) *</label>
                              <small class="form-text text-muted">Price for individual lessons</small>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-floating mb-3">
                              {{ teacher_form.course_price }}
                              <label for="{{ teacher_form.course_price.id_for_label }}">Course Price (USD) *</label>
                              <small class="form-text text-muted">Price for complete courses</small>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <button class="btn-getstarted rounded-pill" type="submit" name="teacher_profile_submit" value="1">
                        {% if teacher_profile %}
                          <i class="bi bi-arrow-repeat me-2"></i>Update Teacher Profile
                        {% else %}
                          <i class="bi bi-plus-circle me-2"></i>Create Teacher Profile
                        {% endif %}
                      </button>
                    </form>
                  </div>
                  
                  <!-- Notifications Section -->
                  <div id="notifications-section" class="profile-section">
                    <h3 class="mb-4">Recent Activity</h3>
                    
                    <div class="notifications-container">
                      {% if recent_purchases or recent_reviews %}
                        
                        <!-- Recent Purchases -->
                        {% if recent_purchases %}
                          <div class="notification-category mb-4">
                            <h5 class="mb-3 text-success">
                              <i class="bi bi-cart-check me-2"></i>Recent Purchases
                            </h5>
                            {% for purchase in recent_purchases %}
                              <div class="notification-item">
                                <div class="notification-header">
                                  <div class="notification-avatar">
                                    <i class="bi bi-bag-check text-success"></i>
                                  </div>
                                  <div class="notification-info">
                                    <h6>Lesson Purchased</h6>
                                    <small class="text-muted">{{ purchase.created_at|timesince }} ago</small>
                                  </div>
                                </div>
                                <div class="notification-content">
                                                                     <p>
                                     <strong>{{ purchase.number_of_lessons }} lesson{{ purchase.number_of_lessons|pluralize }}</strong> with 
                                     <strong>{{ purchase.teacher_profile.first_name }} {{ purchase.teacher_profile.last_name }}</strong>
                                     <br>
                                     <span class="text-muted">Total: ${{ purchase.total_price }}</span>
                                   </p>
                                </div>
                              </div>
                            {% endfor %}
                          </div>
                        {% endif %}

                        <!-- Recent Reviews -->
                        {% if recent_reviews %}
                          <div class="notification-category">
                            <h5 class="mb-3 text-primary">
                              <i class="bi bi-star me-2"></i>Recent Reviews Submitted
                            </h5>
                            {% for review in recent_reviews %}
                              <div class="notification-item">
                                <div class="notification-header">
                                  <div class="notification-avatar">
                                    <i class="bi bi-star-fill text-warning"></i>
                                  </div>
                                  <div class="notification-info">
                                    <h6>Review Submitted</h6>
                                    <small class="text-muted">{{ review.created_at|timesince }} ago</small>
                                  </div>
                                </div>
                                <div class="notification-content">
                                  <p>
                                    You rated <strong>{{ review.teacher.first_name }} {{ review.teacher.last_name }}</strong>
                                    <span class="rating-stars ms-2">
                                      {% for i in "12345" %}
                                        {% if review.rating >= i|add:0 %}
                                          <i class="bi bi-star-fill text-warning"></i>
                                        {% else %}
                                          <i class="bi bi-star text-muted"></i>
                                        {% endif %}
                                      {% endfor %}
                                    </span>
                                    <br>
                                    {% if review.description %}
                                      <span class="text-muted">"{{ review.description|truncatewords:15 }}"</span>
                                    {% endif %}
                                  </p>
                                </div>
                              </div>
                            {% endfor %}
                          </div>
                        {% endif %}

                      {% else %}
                        <!-- Empty state -->
                        <div class="text-center py-5">
                          <i class="bi bi-bell-slash text-muted" style="font-size: 3rem;"></i>
                          <h5 class="text-muted mt-3">No Recent Activity</h5>
                          <p class="text-muted">Your recent purchases and reviews will appear here.</p>
                          <a href="{% url 'landing:home' %}#team" class="btn btn-outline-primary rounded-pill mt-3">
                            <i class="bi bi-search me-2"></i>Find a Teacher
                          </a>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="modal fade" id="confirm-changes-modal" tabindex="-1" aria-labelledby="confirmChangesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header border-0" style="background: linear-gradient(135deg, #942828 0%, #b00006 100%); color: white;">
          <h5 class="modal-title" id="confirmChangesModalLabel">
            <i class="bi bi-exclamation-triangle me-2"></i>Confirm Changes
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <p class="mb-3">You are about to make the following changes:</p>
          <div id="changes-list" class="changes-container">
            <!-- Changes will be populated here by JavaScript -->
          </div>
          <p class="text-muted mt-3 mb-0">
            <small><i class="bi bi-info-circle me-1"></i>Are you sure you want to proceed?</small>
          </p>
        </div>
        <div class="modal-footer border-0 bg-light">
          <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Cancel
          </button>
          <button type="button" class="btn-getstarted rounded-pill px-4" id="confirm-save-btn">
            <i class="bi bi-check-circle me-2"></i>Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
// Profile data passed to JavaScript
window.profileData = {
    first_name: '{{ user.first_name|escapejs }}',
    last_name: '{{ user.last_name|escapejs }}',
    email: '{{ user.email|escapejs }}',
    username: '{{ user.username|escapejs }}'
};

window.teacherProfileData = {
    title: '{% if teacher_profile %}{{ teacher_profile.title|escapejs }}{% endif %}',
    experience: '{% if teacher_profile %}{{ teacher_profile.experience|escapejs }}{% endif %}',
    teaching_years: '{% if teacher_profile %}{{ teacher_profile.teaching_years|default:"" }}{% endif %}',
    lesson_price: '{% if teacher_profile %}{{ teacher_profile.lesson_price }}{% endif %}',
    course_price: '{% if teacher_profile %}{{ teacher_profile.course_price }}{% endif %}',
    avatar: '{% if teacher_profile and teacher_profile.avatar %}{{ teacher_profile.avatar.name|escapejs }}{% endif %}'
};
</script>
{% endblock %}
